{% extends "xero_workspace/mappings.html" %}

{% load static %}

{% block link %}
    <link rel="stylesheet" href="{% static 'css/table.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal.css' %}">
{% endblock %}

{% block title %}Category Mapping{% endblock %}

{% block content %}
    <div class="content">
        <div class="d-flex content-header">
            <h5 class="cardMainText">Category Mapping</h5>
            <button class="ml-auto btn main-btn" type="button" data-toggle="modal"
                    data-target="#categoryMappingModal">New Mapping
            </button>
            <button class="btn main-btn-outline ml-3" type="button" data-toggle="modal"
                    data-target="#bulkAddMappingModal">Bulk Add/Update
            </button>
            <button class="btn main-btn-outline delete-btn ml-3" type="submit" form="delete-form"
                    name="method" value="delete">Delete
            </button>
        </div>
        {% if mappings|length == 0 %}
            <div class="alert alert-light mx-auto warning" role="alert">
                <p>Looks like you don't have any Category Mappings</p>
            </div>
        {% else %}
            <div class="table-layout">
                <div class="table-responsive">
                    <table class="table">
                        <thead class="table-head">
                        <tr class="colHeadings">
                            <th style="width: 35%">category name (Fyle)</th>
                            <th style="width: 35%">Sub-category name (Fyle)</th>
                            <th class="actions">Account Code (Xero)</th>
                            <th>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="select-all"/>
                                    <span class="checkmark"></span>
                                </label>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <form id="delete-form" action="" method="post">
                            {% csrf_token %}
                            {% for mapping in mappings %}
                            <tr onclick="openEditModal(this, {{mapping.id}})" class="category-mapping-table">
                                <td>{{mapping.category}}</td>
                                <td>{{mapping.sub_category}}</td>
                                <td class="actions">{{mapping.account_code}}</td>
                                <td>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="mappingsCheckbox" name="mapping_ids"
                                               value='"{{mapping.id}}"'/>
                                        <span id="checkmark" class="checkmark"></span>
                                    </label>
                                </td>
                            </tr>
                            {% endfor %}
                        </form>
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="nav-pagination">
        {% if mappings.has_other_pages %}
           <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center">
                    {% if mappings.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ mappings.previous_page_number }}">&laquo;</a></li>
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#"><span>&laquo;</span></a></li>
                    {% endif %}

                    {% if mappings.number|add:'-4' > 1 %}
                        <li class="page-item"><a class="page-link" href="?page={{ mappings.number|add:'-5' }}">&hellip;</a></li>
                    {% endif %}

                    {% for i in mappings.paginator.page_range %}
                        {% if mappings.number == i %}
                            <li class="page-item active"><a class="page-link" href="#">{{ i }} <span class="sr-only">(current)</span></a></li>
                        {% elif i > mappings.number|add:'-5' and i < mappings.number|add:'5' %}
                            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if mappings.paginator.num_pages > mappings.number|add:'4' %}
                        <li class="page-item"><a class="page-link" href="?page={{ mappings.number|add:'5' }}">&hellip;</a></li>
                    {% endif %}

                    {% if mappings.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ mappings.next_page_number }}">&raquo;</a></li>
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#"><span>&raquo;</span></a></li>
                    {% endif %}
                </ul>
           </nav>
        {% endif %}
    </div>

    <!-- Modal -->
    <div class="modal fade" id="categoryMappingModal" tabindex="-1" role="dialog"
         aria-labelledby="categoryMappingModalTitle" aria-hidden="true"
         data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryMappingModalTitle">Create New Mapping</h5>
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close" onclick="clearModalValues()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="" method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="floating-label">
                            {{ form.category }}
                            <label class="input-label">{{ form.category.label }}</label>
                        </div>
                        <div class="floating-label">
                            {{ form.sub_category }}
                            <label class="input-label">{{ form.sub_category.label }}</label>
                        </div>
                        <div class="floating-label">
                            {{ form.account_code }}
                            <label class="input-label">{{ form.account_code.label }}</label>
                        </div>
                        <input type="hidden" id="mapping_id" name="mapping_id">
                    </div>
                    <div class="modal-footer">
                        <button id="cancel-btn" class="btn btnInline cancelBtn" type="button"
                                data-dismiss="modal" onclick="clearModalValues()">Cancel</button>
                        <button id="submit-btn" class="btn btnInline saveBtn" type="submit" name="method">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="bulkAddMappingModal" tabindex="-1" role="dialog"
         aria-labelledby="bulkAddMappingModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkAddMappingModalTitle">Bulk Upload Mappings</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{% url 'xero_workspace:category_mapping_bulk_upload' workspace_id %}"
                      method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        {% csrf_token %}
                        {{ form.bulk_upload_file }}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btnInline cancelBtn" type="button" data-dismiss="modal">Cancel</button>
                        <button class="btn btnInline saveBtn" type="submit">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    $(document).ready(function() {
        $("#select-all").click(function() {
            $(".mappingsCheckbox").prop('checked', $(this).prop('checked'));
        });
    });

    $(".mappingsCheckbox").click(function(e) {
        if(e.target.type === 'checkbox') {
            e.stopPropagation();
        }
    });

    function openEditModal(table_row, mapping_id) {
        if (event.target.id !== 'checkmark') {
            const cells = table_row.getElementsByTagName('td');
            $('#id_category').val(cells[0].innerHTML);
            $('#id_sub_category').val(cells[1].innerHTML);
            $('#id_account_code').val(cells[2].innerHTML);
            $('#categoryMappingModalTitle').text('Edit Mapping');
            $('#submit-btn').text('Update');
            $('#submit-btn').val('update');
            $('#mapping_id').val(mapping_id.toString());
            $('#categoryMappingModal').modal('show');
        }
    }

    function clearModalValues() {
        setTimeout(function(){
            $('#categoryMappingModalTitle').text('Create New Mapping');
            $('#id_category').val('');
            $('#id_sub_category').val('');
            $('#id_account_code').val('');
            $('#submit-btn').text('Create');
            $('#submit-btn').removeAttr('name');
            $('#submit-btn').removeAttr('val');
            $('#mapping_id').removeAttr('val');
        }, 150);
    }

{% endblock %}